<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TarifiersDBX-V1 (Stable & Connecté)</title>
    <!-- React & UI -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation Bandeau Défilant */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        /* Barres de progression stylisées */
        .bar-fill { transition: width 1s ease-in-out; }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Canvas PDF Responsive */
        .pdf-canvas-container { overflow: auto; display: flex; justify-content: center; background-color: #525659; height: 100%; }
        canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); margin: 20px 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-8 text-center">
                            <div className="max-w-lg">
                                <h1 className="text-2xl font-bold text-red-600 mb-4">Erreur Système</h1>
                                <p className="text-red-800 mb-6 bg-red-100 p-4 rounded text-left font-mono text-sm overflow-auto">{this.state.error?.toString()}</p>
                                <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700">Relancer l'application</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Configuration PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- CONFIGURATION PERMANENTE (ADMIN) ---
        // REMPLISSEZ CES CHAMPS AVEC VOS CLÉS POUR QUE L'APP MARCHE PARTOUT SANS CONFIGURATION
        const HARDCODED_APP_KEY = "0jxe3h5hj9vm2lk";      // Copier depuis Admin > Paramètres
        const HARDCODED_APP_SECRET = "w39sunmc10iacrn";   // Copier depuis Admin > Paramètres
        const HARDCODED_REFRESH_TOKEN = "sl.u.AGMbo2-eKOHp151zvskrz2zbz_cAmQPb8IR4ON0TrmDb0GviAxZtxuhlgp1Y2t05z925aRaAMgPof2DF6pmW8uc0FrBy_HwNnNXpexKJtMdM1Oa5sFbp83RFb0Mb-RKo4GkDSPyatt90HcN3BOzrwJJ9SChXuaIQT5HEh1O3IzACYeXKs-mmkW_DU2wvz1lEhzQ7zY9ProbIFcIB95ZhYN_9O4ZF5yo2iBsF1ermHSy9Mwt5wF6xbcaBzcrwx_WYLI6asaA4FN2xIUV1RCQepoNpLXeSgW7e8BYEmrn2duTwse92eoszgDymi_njRUtDOoY3abbIm5dkkPmTQSTaJAUtRcHOEQsGviciKZf_EOJUjgBHSfMKa3Tthpyz-fFp0TRoFqCU4-a8FdbgVLY7uXD0rUUT5ALyPZl1qt4yBJJrLydopzAFMJ3PRvsZ-WfvUxktaqRX6cp7RGhRccURPUNbtwiziljUse4DT4idHo6VBuZ3-ppI239DwkqUPOgxuQ9BSzZZotkc7TYdAHtON3MW-y4Sa9xtZ2QJB_reIuqykjYfjsNxLbYuBpm5QareT43ZBXeF-_GrLQb-qzYMf5q3ElXR0RMV-uVXDyd0iK0iljnFP_5LuJ16e2T5mOVVgJCeNu-MunE4eZlWcpUawx95okhqlUz9fc2pY-L3TYwZeZuL8u9XyK2cjpWud-5PXdaECikOVBdcsehx3r3Bb5OQWuc3YJLkc3urMqqUUUHuh_JhtofKmVuS5l3VEejKAO4WA1xDmqd_UCHiNYmFaj3aBBe3v7-zxtxHeGtXu27c8qvzLlL3BCmmrXxMFd06wKHSPT2qlHjHKPBRr-Vhsk_cqjY4-jJNASkjGZJ_OEPVsERIT7TQMYat7KZlANDFWlVhdNBYKHbwTFZbUy8FzR6sAHpipZkJWG_XnOgK1mFjy2P4p8pn-Qb9Vhi5jpuFReo8ZtXCyKSWPMW1vctlIokish4bYLXGOPxpFlhF-pSjLyZb9hHJUaf6yOpbRzBeuvNBAQEB9hRHA63f1ga9ZNlKoA8-m1Y_-2VmtNNoFsJu8RI-Knd1ehB5TQMu7MHU_qhq6prKrBLMB85jfLl3xG-RcoClvsyecbziFywNz5FAYV-fFt94bxkjGHI3sLc_GDUXNf1kW2vsXQsxbC-rToPK1ITvBqMHflSnAV6XWB99Nhpe5B9DF4w6QkGkQS0-JBWnvWmeHlp92rELifF-De2aoRJi7mrjDu89COQVCJjJRYoe49GBaDonDVNTppiPSgb5tJ-CaCEZnCeyPVD_-__R";// Copier depuis Admin > Paramètres (Le code long)
        const HARDCODED_GEMINI_KEY = "";   // Votre clé IA (Facultatif si déjà sur Cloud)

        // Token de secours (Utilisé uniquement si les champs ci-dessus sont vides)
        const HARDCODED_DBX_TOKEN = "sl.u.AGNfi6dpn3OFF0iwMt2YWKrXQPCBk9WhThHZjSOxyR6XwFQFfq4ZBCUQqGgyeYThtWx-clnclh4ibhqOJYq8URbMFSO7o8dH0wpsv-cvPFS4CTI_fVEgvkRu0Mstv6uATcBireQO0Nic7fGXE61r6Z0B7y7fetsR-wJLStIugVeuYrcKDylZ25HIN2_UqVaVmsGnKggLlnypRmtOPiE4wIDtK6WoQbDEJywSotHYgSkOy13jutfwMi5CXvNkScstsxrYK9B1qE6KE4YTGU5swho5u0Gs7vlmERaUbaewcQf00YkrriYj1VFV35Y4-3l15kVxpdaVpB-mtFTnY4vjYJ_EJnKRk-C9F02M6zE8wKzWJNTAbfa0Pfm1NlQRKprtv4TZcOJfR39zNgxnK96eteXIg7YCkortY122aOh9tRrq0X8z69_VO0u2NdDnYsrX8luKybf3O8YyDn4R0c7ONo1fGyrcVtfcCZ6YBWmNR-CT1TEdniGwNSokHcjYK8n_HoRTP0226FBY0CTn0ZI02usi-9C3mdkpL7o-64UOJ-BcWJj5l8MULbMSF_Schh8j58AF8ZlcCrN-PA2w3IPAtE90WfkVVSG7uQp8xCC6oR0Vh-wMQ7VdTL29tQrEJ9h9MfMk_wJvjKuV4PbgdQiVX0ATmSsbfPOdUadMDAZvJWuOMQ8khanPym-ColgE2AoU-oaMkgE93kwxUFIgWX5FwtAL77KGorowNKk9v45geF-rkGdn6Khi8w9ZhG9BjUMlfkn_cxHVzD9sh8goxXqVXsw6IYDcq2-ILIIU7F3OnlielMyFRyh1tQTOaQPZzArZ_ZmAu7hpuUInqoa3kbkH71isRpdRaeKEQvLV2tJH5h0ytyEm2WCgIwbSP3obOs6Ag4cOJGLD2gKRds6PKUGakauJE7xunNeenm6ozNXjdeJEM_-JXwdVHrJuH2WD0huwlfN6ZvatM39Doga1XNCFj91cYFUlIS86FwTyWWKKbnnFXlKaKcTTJI32TWzYcj7nFsesCxVAjDc9rwD4Sg2LGOXxHBLFFu0MkV9vvSCRybCTb2BP8vObpHdsQjalIC8778e1kNcg4z4J5xyzAXn82idxs0eG8j6o6LKndkRqDkSsVwFfkVGe9uDdNEDpzvr02xAiT5sTfbbVfG_VC9Q6MIYX5YpP25O_O_d5z9Wa8V9QAN8ocZ8NHOUpkbPWAegI7Yy0Q-earUEdn2xf9KonmuZMUXmrR2FjcGNYEWXylyvLDuZdt_MJsfZtPyHTGyb7TMhhEuj8BgaxtrvP6uk8Zvxx"; 
        
        // Comptes par défaut (toujours disponibles en secours)
        const DEFAULT_USERS = [
            { id: 'admin', pass: 'admin', role: 'admin', name: 'Administrateur', searchCount: 0 },
            { id: 'collab', pass: '1234', role: 'viewer', name: 'Collaborateur', searchCount: 0 }
        ];

        // --- CITATIONS ---
        const QUOTES = [
            { text: "La seule façon de faire du bon travail est d'aimer ce que vous faites.", author: "Steve Jobs" },
            { text: "Le succès n'est pas final, l'échec n'est pas fatal : c'est le courage de continuer qui compte.", author: "Winston Churchill" },
            { text: "La qualité signifie bien faire les choses quand personne ne regarde.", author: "Henry Ford" },
            { text: "La simplicité est la sophistication suprême.", author: "Léonard de Vinci" },
            { text: "Il n'y a pas de vent favorable pour celui qui ne sait pas où il va.", author: "Sénèque" }
        ];

        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- OAUTH HELPERS ---
        const exchangeCodeForToken = async (code, appKey, appSecret) => {
            const details = { 'code': code, 'grant_type': 'authorization_code', 'client_id': appKey, 'client_secret': appSecret };
            const formBody = Object.keys(details).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(details[key])).join('&');
            const res = await fetch('https://api.dropbox.com/oauth2/token', {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody
            });
            if(!res.ok) throw new Error(await res.text());
            return await res.json();
        };

        const refreshAccessToken = async (refreshToken, appKey, appSecret) => {
            try {
                const details = { 'grant_type': 'refresh_token', 'refresh_token': refreshToken, 'client_id': appKey, 'client_secret': appSecret };
                const formBody = Object.keys(details).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(details[key])).join('&');
                const res = await fetch('https://api.dropbox.com/oauth2/token', {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody
                });
                const data = await res.json();
                if(data.access_token) return data.access_token;
                throw new Error("Pas de token dans la réponse refresh");
            } catch(e) {
                console.error("Echec Refresh:", e);
                return null;
            }
        };

        // --- API MANAGER ---
        // Remplace fetchWithRetry pour intégrer le refresh automatique
        const apiFetch = async (url, options, config, setConfig) => {
            // Fonction interne récursive
            const doRequest = async (token, retries = 3) => {
                const headers = { ...options.headers };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                try {
                    const res = await fetch(url, { ...options, headers });
                    
                    // 1. Gestion Expiration Token (401)
                    if (res.status === 401 && config.refreshToken && config.appKey && config.appSecret) {
                        console.warn("Token expiré (401). Tentative de rafraîchissement...");
                        const newToken = await refreshAccessToken(config.refreshToken, config.appKey, config.appSecret);
                        if (newToken) {
                            // Sauvegarde du nouveau token
                            const newConfig = { ...config, token: newToken };
                            setConfig(newConfig);
                            localStorage.setItem('tdbx_config', JSON.stringify(newConfig));
                            // Retry immédiat avec le nouveau token
                            return await doRequest(newToken, retries);
                        }
                    }

                    // 2. Gestion Rate Limit (429) ou Erreur Serveur (5xx)
                    if (!res.ok && (res.status === 429 || res.status >= 500)) {
                        if (retries > 0) {
                            await delay(1500);
                            return await doRequest(token, retries - 1);
                        }
                    }
                    
                    // 3. Autres erreurs ou succès
                    if (!res.ok) {
                        const errorText = await res.text();
                        // DÉTECTION INTELLIGENTE DE L'ERREUR D'EXPIRATION
                        // Si le token est expiré et qu'on n'a pas pu le rafraîchir (pas de refresh token sur ce device)
                        if (errorText.includes("expired_access_token") || errorText.includes("invalid_access_token")) {
                            throw new Error("EXPIRED_TOKEN_ALERT");
                        }
                        throw new Error(errorText);
                    }
                    return res;

                } catch (err) {
                    if (retries > 0 && err.message !== "EXPIRED_TOKEN_ALERT") { await delay(1000); return await doRequest(token, retries - 1); }
                    throw err;
                }
            };
            
            // Premier appel avec le token actuel. 
            // Si on a un refresh token hardcodé mais pas de token valide, on tente le refresh d'abord
            let currentToken = config.token;
            if (!currentToken && config.refreshToken && config.appKey && config.appSecret) {
                 try {
                     console.log("Initialisation via Refresh Token Hardcodé...");
                     const refreshed = await refreshAccessToken(config.refreshToken, config.appKey, config.appSecret);
                     if(refreshed) {
                         currentToken = refreshed;
                         setConfig({...config, token: refreshed});
                     }
                 } catch(e) { console.warn("Echec init refresh", e); }
            }

            return doRequest(currentToken);
        };

        // --- WRAPPERS SERVICES DROPBOX ---
        const DROPBOX_API_URL = "https://api.dropboxapi.com/2";
        const DROPBOX_CONTENT_URL = "https://content.dropboxapi.com/2";

        const dbxListFolder = async (config, setConfig) => {
            const res = await apiFetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: config.pathTarifs === '/' ? '' : config.pathTarifs, recursive: false })
            }, config, setConfig);
            return await res.json();
        };

        const dbxListFolderFiches = async (config, setConfig) => {
            const res = await apiFetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: config.pathFT === '/' ? '' : config.pathFT, recursive: false })
            }, config, setConfig);
            return await res.json();
        };

        const dbxDownloadFile = async (config, setConfig, path) => {
            const res = await apiFetch(`${DROPBOX_CONTENT_URL}/files/download`, {
                method: 'POST',
                headers: { 'Dropbox-API-Arg': JSON.stringify({ path }) }
            }, config, setConfig);
            return await res.blob();
        };

        const dbxGetLink = async (config, setConfig, path) => {
            const res = await apiFetch(`${DROPBOX_API_URL}/files/get_temporary_link`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            }, config, setConfig);
            return await res.json();
        };

        const dbxUploadFile = async (config, setConfig, path, content) => {
            const res = await apiFetch(`${DROPBOX_CONTENT_URL}/files/upload`, {
                method: 'POST',
                headers: { 
                    'Dropbox-API-Arg': JSON.stringify({ path, mode: 'overwrite', mute: true }),
                    'Content-Type': 'application/octet-stream'
                },
                body: content
            }, config, setConfig);
            return await res.json();
        };

        // --- IA GOOGLE ---
        const callIA = async (payload, key, retryCount = 0) => {
            const modelVersion = 'gemini-2.5-flash-preview-09-2025';
            if (!key) throw new Error("Clé API Gemini manquante");

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelVersion}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (res.status === 429) {
                    if (retryCount < 3) {
                        const waitTime = 2000 * Math.pow(2, retryCount);
                        await delay(waitTime);
                        return callIA(payload, key, retryCount + 1);
                    }
                    throw new Error("Quota IA épuisé (429).");
                }
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error?.message || `Erreur IA HTTP ${res.status}`);
                }
                return await res.json();
            } catch (e) { throw e; }
        };

        const extractJSON = (text) => {
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) return text.substring(firstBrace, lastBrace + 1);
            return text;
        };

        const extractDateFromFilename = (filename) => {
            const regex = /(\d{1,2})[-._/](\d{1,2})[-._/](\d{2,4})/;
            const match = filename.match(regex);
            if (match) {
                let day = match[1].padStart(2, '0');
                let month = match[2].padStart(2, '0');
                let year = match[3];
                if (year.length === 2) year = '20' + year;
                return `${day}/${month}/${year}`;
            }
            return null;
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current && name) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        // --- APPLICATION ---
        function App() {
            // STATE
            const [users, setUsers] = useState(DEFAULT_USERS);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');

            const [tarifs, setTarifs] = useState([]);
            const [fiches, setFiches] = useState([]); 
            const [dbHistory, setDbHistory] = useState([]);
            const [dbMeta, setDbMeta] = useState(null);
            // Config enrichie pour OAuth
            const [dbxConfig, setDbxConfig] = useState({ 
                token: HARDCODED_DBX_TOKEN, 
                refreshToken: HARDCODED_REFRESH_TOKEN || '', 
                appKey: HARDCODED_APP_KEY || '', 
                appSecret: HARDCODED_APP_SECRET || '', 
                pathTarifs: '/Tarifs', 
                pathFT: '/Fiches', 
                geminiKey: HARDCODED_GEMINI_KEY || '' 
            });
            
            const [view, setView] = useState('login'); 
            const [activeTab, setActiveTab] = useState('search'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [syncLog, setSyncLog] = useState('');
            const [syncStatus, setSyncStatus] = useState('idle');
            const [isUploading, setIsUploading] = useState(false);
            const [showQuoteModal, setShowQuoteModal] = useState(false);
            const [currentQuote, setCurrentQuote] = useState(null);
            const [showConfigModal, setShowConfigModal] = useState(false); // Ajout variable manquante

            // NOUVEAU : ETAT POUR LE VISUALISATEUR (PDF.js)
            const [viewingFile, setViewingFile] = useState(null);
            const [isFileLoading, setIsFileLoading] = useState(false);
            // État spécifique pour PDF.js (pagination, zoom)
            const [pdfState, setPdfState] = useState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 });
            const canvasRef = useRef(null);

            // ADMIN UI
            const [showAdminUploadModal, setShowAdminUploadModal] = useState(false);
            const [adminUploadMode, setAdminUploadMode] = useState('new');
            const [targetTarifId, setTargetTarifId] = useState('');
            const [authCode, setAuthCode] = useState(''); // Code OAuth
            
            // USER EDIT UI
            const [editingUserIdx, setEditingUserIdx] = useState(null);
            const [userFormData, setUserFormData] = useState({ name: '', login: '', pass: '', role: 'viewer' });
            const [showPassword, setShowPassword] = useState({});

            const uploadInputRef = useRef(null);
            const adminFileInputRef = useRef(null);

            // --- INIT & PERSISTENCE ---
            useEffect(() => {
                const storedConfig = localStorage.getItem('tdbx_config');
                const storedUsers = localStorage.getItem('tdbx_users');
                const storedTarifs = localStorage.getItem('tdbx_tarifs'); 
                const storedFiches = localStorage.getItem('tdbx_fiches');
                const storedHistory = localStorage.getItem('tdbx_history');
                const storedMeta = localStorage.getItem('tdbx_meta');

                if (storedConfig) {
                    const parsed = JSON.parse(storedConfig);
                    // Priorité au token hardcodé s'il est plus récent ou présent
                    if(HARDCODED_DBX_TOKEN && !parsed.token) parsed.token = HARDCODED_DBX_TOKEN;
                    // Priorité aux refresh tokens hardcodés s'ils sont présents dans le code source
                    if(HARDCODED_REFRESH_TOKEN) parsed.refreshToken = HARDCODED_REFRESH_TOKEN;
                    if(HARDCODED_APP_KEY) parsed.appKey = HARDCODED_APP_KEY;
                    if(HARDCODED_APP_SECRET) parsed.appSecret = HARDCODED_APP_SECRET;
                    if(HARDCODED_GEMINI_KEY) parsed.geminiKey = HARDCODED_GEMINI_KEY;
                    
                    setDbxConfig(parsed);
                } else {
                    // Premier lancement
                    setDbxConfig(prev => ({
                        ...prev, 
                        token: HARDCODED_DBX_TOKEN,
                        refreshToken: HARDCODED_REFRESH_TOKEN,
                        appKey: HARDCODED_APP_KEY,
                        appSecret: HARDCODED_APP_SECRET,
                        geminiKey: HARDCODED_GEMINI_KEY
                    }));
                }

                if (storedUsers) setUsers(JSON.parse(storedUsers));
                if (storedTarifs) setTarifs(JSON.parse(storedTarifs));
                if (storedFiches) setFiches(JSON.parse(storedFiches));
                if (storedHistory) setDbHistory(JSON.parse(storedHistory));
                if (storedMeta) setDbMeta(JSON.parse(storedMeta));
            }, []);

            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_config', JSON.stringify(dbxConfig)); }, [dbxConfig, currentUser]);
            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_users', JSON.stringify(users)); }, [users, currentUser]);

            // --- AUTO REFRESH (POLLING & STARTUP) ---
            useEffect(() => {
                let interval;
                // MODIFICATION : On autorise le chargement si on est connecté OU si on est sur la page de login (pour charger les users)
                // ET si on a soit un token, soit un moyen d'en avoir (refreshToken)
                if ((currentUser || view === 'login') && (dbxConfig.token || (dbxConfig.refreshToken && dbxConfig.appKey))) {
                    // Chargement initial (sauf si on a déjà des données et qu'on est juste en navigation, mais sur login on force pour avoir les users)
                    if(tarifs.length === 0 || view === 'login') loadCloudDatabase(view !== 'login'); // Silent seulement si déjà connecté

                    // Polling toutes les 60s
                    interval = setInterval(() => {
                        console.log("Auto-refreshing data...");
                        loadCloudDatabase(true); 
                    }, 60000);
                }
                return () => clearInterval(interval);
            }, [currentUser, dbxConfig.token, dbxConfig.refreshToken, view]); // Ajout de 'view' aux dépendances

            // --- OAUTH FLOW ---
            const handleExchangeCode = async () => {
                if(!authCode || !dbxConfig.appKey || !dbxConfig.appSecret) return alert("Infos manquantes (App Key, Secret, Code).");
                setSyncStatus('working');
                try {
                    const data = await exchangeCodeForToken(authCode, dbxConfig.appKey, dbxConfig.appSecret);
                    
                    const newConfig = { 
                        ...dbxConfig, 
                        token: data.access_token, 
                        refreshToken: data.refresh_token // LE SAINT GRAAL
                    };
                    setDbxConfig(newConfig);
                    localStorage.setItem('tdbx_config', JSON.stringify(newConfig));
                    
                    // SAUVEGARDE IMMEDIATE DE LA CONFIG SUR LE CLOUD
                    // Pour que les autres utilisateurs la récupèrent
                    await saveToCloud(null, null, null, null, newConfig);

                    setSyncLog("✅ Refresh Token configuré et partagé avec succès !");
                    setSyncStatus('success');
                    setAuthCode('');
                    alert("Succès ! Connexion permanente établie et partagée avec l'équipe.\n\nIMPORTANT: Copiez les valeurs affichées dans l'onglet Admin vers le code source pour que cela marche sur de nouveaux appareils !");
                } catch(e) {
                    setSyncLog("❌ Erreur OAuth : " + e.message);
                    setSyncStatus('error');
                    alert("Erreur : " + e.message);
                }
            };

            // --- CLOUD OPERATIONS ---
            const saveToCloud = async (newTarifs, newFiches, newHistory, newUsers, specificConfig) => {
                // On inclut la config (Refresh Token, App Key/Secret) dans la DB partagée
                const configToSave = specificConfig || {
                    refreshToken: dbxConfig.refreshToken,
                    appKey: dbxConfig.appKey,
                    appSecret: dbxConfig.appSecret,
                    geminiKey: dbxConfig.geminiKey
                };

                const dataToSave = {
                    meta: { date: new Date().toLocaleString(), user: currentUser?.name || 'System' },
                    config: configToSave, // SECTION CRITIQUE POUR LE PARTAGE D'ACCES
                    history: newHistory || dbHistory,
                    tarifs: newTarifs || tarifs,
                    fiches: newFiches || fiches,
                    users: newUsers || users 
                };
                // Utilisation de apiFetch via les wrappers
                await dbxUploadFile(dbxConfig, setDbxConfig, '/db_tarifs.json', new Blob([JSON.stringify(dataToSave)], { type: 'application/json' }));
            };

            const loadCloudDatabase = async (silent = false) => {
                // On peut charger si on a un token OU si on a de quoi en faire un
                if (!dbxConfig.token && !(dbxConfig.refreshToken && dbxConfig.appKey)) return;
                
                if (!silent) { setSyncStatus('working'); setSyncLog("Chargement Cloud..."); }
                
                try {
                    const blob = await dbxDownloadFile(dbxConfig, setDbxConfig, '/db_tarifs.json');
                    const text = await blob.text();
                    const data = JSON.parse(text);
                    
                    setTarifs(data.tarifs || []);
                    setFiches(data.fiches || []);
                    setDbHistory(data.history || []);
                    if (data.meta) setDbMeta(data.meta);
                    
                    // MISE A JOUR DES UTILISATEURS CRITIQUE
                    if (data.users && Array.isArray(data.users)) {
                        setUsers(data.users);
                        // Sauvegarde locale immédiate pour que le login fonctionne
                        localStorage.setItem('tdbx_users', JSON.stringify(data.users));
                    }

                    // MISE A JOUR AUTOMATIQUE DE LA CONFIGURATION (OAUTH PARTAGÉ)
                    if (data.config && data.config.refreshToken) {
                        // On update seulement si on n'a pas de config locale ou si elle est différente
                        // Mais on ne veut pas écraser une config locale valide par une config cloud vide
                        if (data.config.refreshToken && data.config.refreshToken !== dbxConfig.refreshToken) {
                            const newSharedConfig = { ...dbxConfig, ...data.config };
                            setDbxConfig(newSharedConfig);
                            localStorage.setItem('tdbx_config', JSON.stringify(newSharedConfig));
                            if (!silent) console.log("Configuration OAuth mise à jour depuis le Cloud.");
                        }
                    }

                    if (!silent) { setSyncLog("✅ Données à jour."); setSyncStatus('success'); }
                } catch (e) {
                    console.error("Sync error", e);
                    if (e.message === "EXPIRED_TOKEN_ALERT") {
                        if (!silent) { 
                            setSyncLog("⚠️ Token expiré et pas de Refresh Token valide.");
                            setSyncStatus('error');
                            // On force l'ouverture de la config pour permettre une réparation manuelle uniquement si c'est nécessaire
                            if(users.length <= 2) setShowConfigModal(true); // Si on n'a que les users par défaut, c'est critique
                        }
                    } else {
                        if (!silent) { setSyncLog("⚠️ Erreur Sync : " + e.message); setSyncStatus('error'); }
                    }
                }
            };

            // --- LOGIN ---
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.id === loginForm.username && u.pass === loginForm.password);
                
                if (user) {
                    setCurrentUser(user);
                    setLoginError('');
                    setView('dashboard');
                    
                    const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                    setCurrentQuote(randomQuote);
                    setShowQuoteModal(true);

                    // Demande config si rien du tout (ni token, ni refresh)
                    if (!dbxConfig.token && !dbxConfig.refreshToken && !HARDCODED_DBX_TOKEN) setShowConfigModal(true);
                } else {
                    setLoginError('Identifiants incorrects');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setView('login');
                setLoginForm({ username: '', password: '' });
                setSearchQuery('');
                setActiveTab('search');
            };

            // --- ACTIONS & VIEWER LOGIC ---
            
            // 1. Ouvrir le fichier (Volatile, In-Memory)
            const openFile = async (path, name) => {
                setIsFileLoading(true);
                setViewingFile(null); // Reset
                setPdfState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 }); // Reset PDF state

                try {
                    // On télécharge le fichier comme un Blob brut
                    const rawBlob = await dbxDownloadFile(dbxConfig, setDbxConfig, path);
                    const safeName = name || "Document";
                    
                    // DETECTION PLUS ROBUSTE DU TYPE DE FICHIER
                    // On vérifie le nom passé ET l'extension du chemin
                    const pathIsPdf = path && path.toLowerCase().endsWith('.pdf');
                    const nameIsPdf = safeName.toLowerCase().endsWith('.pdf');
                    const isPdf = pathIsPdf || nameIsPdf; // Si l'un des deux indique PDF, c'est un PDF
                    
                    // CRUCIAL: Forcer le type MIME pour être sûr que c'est bien reconnu
                    const typedBlob = new Blob([rawBlob], { type: isPdf ? 'application/pdf' : rawBlob.type });
                    const url = URL.createObjectURL(typedBlob);
                    
                    setViewingFile({ url, name: safeName, type: isPdf ? 'pdf' : 'image' });
                    
                    // Si PDF, on initialise le rendu PDF.js
                    if (isPdf) {
                        try {
                            const loadingTask = pdfjsLib.getDocument(url);
                            const loadedPdf = await loadingTask.promise;
                            setPdfState(prev => ({ ...prev, pdfDoc: loadedPdf, numPages: loadedPdf.numPages, pageNum: 1 }));
                        } catch(pdfErr) {
                            console.error("Erreur init PDF.js", pdfErr);
                            alert("Erreur lecture PDF interne. Le fichier sera téléchargé.");
                            // Fallback download ou iframe simple
                        }
                    }

                } catch(e) { 
                    alert("Erreur ouverture : " + e.message); 
                } finally { 
                    setIsFileLoading(false); 
                }
            };

            // 2. Rendu de la page PDF (Effect)
            useEffect(() => {
                const renderPage = async () => {
                    if (!viewingFile || viewingFile.type !== 'pdf' || !pdfState.pdfDoc || !canvasRef.current) return;
                    
                    try {
                        const page = await pdfState.pdfDoc.getPage(pdfState.pageNum);
                        const viewport = page.getViewport({ scale: pdfState.scale });
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        const renderContext = { canvasContext: context, viewport: viewport };
                        await page.render(renderContext).promise;
                    } catch (e) { console.error("Erreur rendu page PDF", e); }
                };
                renderPage();
            }, [pdfState.pdfDoc, pdfState.pageNum, pdfState.scale, viewingFile]);

            // 3. Contrôles PDF
            const changePage = (offset) => setPdfState(prev => ({ ...prev, pageNum: Math.min(Math.max(1, prev.pageNum + offset), prev.numPages) }));
            const zoomPdf = (delta) => setPdfState(prev => ({ ...prev, scale: Math.max(0.5, prev.scale + delta) }));

            // 4. Fermeture et Nettoyage Mémoire
            const closeViewer = () => {
                if(viewingFile?.url) URL.revokeObjectURL(viewingFile.url); // Nettoyage mémoire (blob)
                setViewingFile(null);
                setPdfState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 });
            };

            const handleUploadFiche = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const targetPath = `${dbxConfig.pathFT || '/Fiches'}/${file.name}`;
                    await dbxUploadFile(dbxConfig, setDbxConfig, targetPath, file);
                    const newFiche = { id: 'local_' + Date.now(), name: file.name, path: targetPath, type: 'ft', server_modified: new Date().toISOString(), index_date: new Date().toLocaleString() };
                    const newFichesList = [newFiche, ...fiches];
                    setFiches(newFichesList);
                    saveToCloud(null, newFichesList, null, null).catch(console.error);
                    alert(`Fiche ajoutée et publiée !`);
                } catch (err) { alert("Erreur : " + err.message); } finally { setIsUploading(false); if(uploadInputRef.current) uploadInputRef.current.value = ''; }
            };

            // --- ADMIN LOGIC ---
            const analyzePDF = async (blob, filename) => {
                try {
                    const arrayBuffer = await blob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let allProducts = [];
                    let extractedDate = "Non daté";
                    const filenameDate = extractDateFromFilename(filename);
                    const maxPages = Math.min(pdf.numPages, 10); 
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        const base64Img = canvas.toDataURL('image/png').split(',')[1];
                        
                        // MISE A JOUR DU PROMPT POUR L'ASTERISQUE (*)
                        let prompt = i === 1 
                            ? `Analyse page ${i}. Cherche date (format JJ/MM/AAAA) sinon "${filenameDate}". IMPORTANT: Si un produit a un astérisque (*) avant ou après son nom, GARDE-LE dans le champ "name" (ex: "Produit *"). JSON: { "date_tarif": "...", "products": [ {"name": "...", "price": "...", "unit": "..."} ] }` 
                            : `Analyse page ${i}. IMPORTANT: Si un produit a un astérisque (*) avant ou après son nom, GARDE-LE dans le champ "name". JSON produits uniquement: { "products": [ {"name": "...", "price": "...", "unit": "..."} ] }`;
                        
                        if (i > 1) await delay(1000);
                        try {
                            const result = await callIA({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Img } } ] }], generationConfig: { responseMimeType: "application/json" } }, dbxConfig.geminiKey);
                            const pageData = JSON.parse(extractJSON(result.candidates[0].content.parts[0].text));
                            if (i === 1 && pageData.date_tarif) extractedDate = pageData.date_tarif;
                            if (pageData.products) allProducts = [...allProducts, ...pageData.products];
                        } catch (pageErr) { console.warn(`Page ${i} skip:`, pageErr); }
                    }
                    return { date_tarif: extractedDate, products: allProducts };
                } catch (e) { return { date_tarif: extractDateFromFilename(filename) || "Erreur", products: [] }; }
            };

            const handleManualTarifUpload = async (e) => {
                e.preventDefault();
                const file = adminFileInputRef.current?.files[0];
                if (!file || !dbxConfig.geminiKey) return alert("Erreur config/fichier.");
                setSyncStatus('working');
                setSyncLog("Traitement manuel...");
                setShowAdminUploadModal(false);
                try {
                    const targetPath = `${dbxConfig.pathTarifs || '/Tarifs'}/${file.name}`;
                    const uploadMeta = await dbxUploadFile(dbxConfig, setDbxConfig, targetPath, file);
                    const analysis = await analyzePDF(file, file.name);
                    let newTarifs = [...tarifs];
                    if (adminUploadMode === 'update' && targetTarifId) newTarifs = newTarifs.filter(t => t.id !== targetTarifId);
                    const docEntry = { id: uploadMeta.id, name: uploadMeta.name, path: uploadMeta.path_lower, server_modified: uploadMeta.server_modified, index_date: new Date().toLocaleString(), date_tarif: analysis.date_tarif, products: analysis.products };
                    newTarifs.push(docEntry);
                    setTarifs(newTarifs);
                    const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: adminUploadMode === 'new' ? `Ajout: ${file.name}` : `MAJ: ${file.name}` };
                    const updatedHistory = [newHistoryEntry, ...dbHistory].slice(0, 10);
                    setDbHistory(updatedHistory);
                    await saveToCloud(newTarifs, fiches, updatedHistory, users);
                    setSyncLog(`✅ ${file.name} traité.`);
                    setSyncStatus('success');
                } catch (err) { setSyncLog(`❌ Erreur: ${err.message}`); setSyncStatus('error'); } 
                finally { if (adminFileInputRef.current) adminFileInputRef.current.value = ''; }
            };

            const runFullSync = async (forceAll = false) => {
                setSyncStatus('working');
                setSyncLog("Scan global...");
                let currentTarifs = [...tarifs];
                let currentFiches = [...fiches];
                try {
                    const listTarifs = await dbxListFolder(dbxConfig, setDbxConfig);
                    const dbxTarifs = listTarifs.entries.filter(e => e['.tag'] === 'file' && e.name.toLowerCase().endsWith('.pdf'));
                    currentTarifs = currentTarifs.filter(t => dbxTarifs.find(df => df.id === t.id));
                    for (const file of dbxTarifs) {
                        const existing = currentTarifs.find(t => t.id === file.id);
                        if (forceAll || !existing || existing.server_modified !== file.server_modified) {
                            setSyncLog(`> Indexation: ${file.name}...`);
                            try {
                                const blob = await dbxDownloadFile(dbxConfig, setDbxConfig, file.path_lower);
                                await delay(1000);
                                const analysis = await analyzePDF(blob, file.name);
                                currentTarifs = currentTarifs.filter(t => t.id !== file.id);
                                currentTarifs.push({ id: file.id, name: file.name, path: file.path_lower, server_modified: file.server_modified, index_date: new Date().toLocaleString(), date_tarif: analysis.date_tarif, products: analysis.products });
                            } catch(e) { setSyncLog(`Erreur ${file.name}: ${e.message}`); }
                        }
                    }
                    setTarifs(currentTarifs);
                    if (dbxConfig.pathFT) {
                        try {
                            const listFT = await dbxListFolderFiches(dbxConfig, setDbxConfig);
                            currentFiches = listFT.entries.filter(e => e['.tag'] === 'file').map(f => ({ id: f.id, name: f.name, path: f.path_lower, type: 'ft', server_modified: f.server_modified, index_date: new Date().toLocaleString() }));
                            setFiches(currentFiches);
                        } catch(e) {}
                    }
                    const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: "Synchronisation Globale" };
                    const updatedHistory = [newHistoryEntry, ...dbHistory].slice(0, 10);
                    setDbHistory(updatedHistory);
                    await saveToCloud(currentTarifs, currentFiches, updatedHistory, users);
                    setSyncLog("Terminé.");
                    setSyncStatus('success');
                } catch(e) { setSyncLog("Erreur Sync: " + e.message); setSyncStatus('error'); }
            };

            // MODIFICATION: AJOUT SUPPRESSION TOTALE
            const handleDeleteAllTarifs = async () => {
                if(!confirm("ATTENTION : Cela va supprimer TOUS les tarifs de l'index (la base de données). Les fichiers PDF sur Dropbox ne seront PAS effacés. Continuer ?")) return;
                setSyncStatus('working');
                try {
                    const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: "Suppression Totale des Tarifs" };
                    const updatedHistory = [newHistoryEntry, ...dbHistory].slice(0, 10);
                    setDbHistory(updatedHistory);
                    
                    setTarifs([]); // Clear local
                    
                    await saveToCloud([], fiches, updatedHistory, users); // Save empty array
                    setSyncLog("✅ Tous les tarifs ont été supprimés de l'index.");
                    setSyncStatus('success');
                } catch(e) {
                    setSyncLog("❌ Erreur suppression totale : " + e.message);
                    setSyncStatus('error');
                    alert("Erreur : " + e.message);
                    // Reload to restore state if failed
                    loadCloudDatabase(true);
                }
            };

            // MODIFICATION: AMELIORATION SUPPRESSION UNITAIRE (ROLLBACK EN CAS D'ERREUR)
            const handleDeleteEntry = async (type, id, name) => {
                if(!confirm(`Supprimer "${name}" ?`)) return;
                setSyncStatus('working');
                
                // Optimistic UI Update (On sauvegarde l'état avant modif)
                const prevTarifs = [...tarifs];
                const prevFiches = [...fiches];
                
                let newTarifs = type === 'tarif' ? tarifs.filter(t => t.id !== id) : tarifs;
                let newFiches = type === 'fiche' ? fiches.filter(f => f.id !== id) : fiches;
                
                setTarifs(newTarifs); 
                setFiches(newFiches);
                
                try {
                    const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: `Suppression : ${name}` };
                    const updatedHistory = [newHistoryEntry, ...dbHistory].slice(0, 10);
                    setDbHistory(updatedHistory);
                    await saveToCloud(newTarifs, newFiches, updatedHistory, users);
                    setSyncLog(`✅ "${name}" supprimé.`);
                    setSyncStatus('success');
                } catch(e) { 
                    setSyncLog("Err delete: " + e.message); 
                    setSyncStatus('error'); 
                    alert("Echec de la suppression sur le Cloud : " + e.message + "\nL'élément a été restauré.");
                    // Rollback (Annulation si échec)
                    setTarifs(prevTarifs);
                    setFiches(prevFiches);
                }
            };

            const handleUserSubmit = async (e) => {
                e.preventDefault();
                const newUser = { name: userFormData.name, id: userFormData.login, pass: userFormData.pass, role: userFormData.role, searchCount: 0 };
                let updatedUsers = [...users];
                if (editingUserIdx !== null) {
                    updatedUsers[editingUserIdx] = { ...updatedUsers[editingUserIdx], ...newUser };
                    setEditingUserIdx(null);
                } else {
                    if(users.find(u => u.id === newUser.id)) return alert("ID existant");
                    updatedUsers.push(newUser);
                    if (newUser.role === 'admin') updatedUsers = updatedUsers.filter(u => !(u.id === 'admin' && u.pass === 'admin'));
                }
                setUsers(updatedUsers);
                setUserFormData({ name: '', login: '', pass: '', role: 'viewer' });
                try { await saveToCloud(null, null, null, updatedUsers); alert("Enregistré et synchronisé !"); } catch(err) { alert("Erreur sync cloud : " + err.message); }
            };

            const handleManualCloudSave = async () => {
                setSyncStatus('working');
                setSyncLog("Sauvegarde Cloud...");
                try {
                    await saveToCloud();
                    setSyncLog("✅ Sauvegardé.");
                    setSyncStatus('success');
                    alert("Base publiée sur le Cloud !");
                } catch (e) {
                    setSyncLog("❌ Erreur : " + e.message);
                    setSyncStatus('error');
                    alert("Erreur : " + e.message);
                }
            };
            
            const handleLocalExport = () => {
                const dataToExport = { exportDate: new Date().toLocaleString(), history: dbHistory, tarifs: tarifs, fiches: fiches, users: users };
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup_tarifiers_dbx.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            // --- SEARCH LOGIC ---
            const searchResults = useMemo(() => {
                if (!searchQuery || searchQuery.length < 2) return { products: [], fiches: [] };
                const q = searchQuery.toLowerCase();
                const foundProducts = [];
                (tarifs || []).forEach(t => {
                    if (t.products) t.products.forEach(p => {
                        if (p.name?.toLowerCase().includes(q)) foundProducts.push({ ...p, source: t.name, date_tarif: t.date_tarif, path: t.path, type: 'prod' });
                    });
                });
                const foundFiches = (fiches || []).filter(f => f.name.toLowerCase().includes(q));
                return { products: foundProducts, fiches: foundFiches };
            }, [searchQuery, tarifs, fiches]);

            // --- VIEW LOGIN ---
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    {showConfigModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full animate-fade">
                                <h2 className="text-xl font-bold mb-2">Configuration Initiale</h2>
                                <p className="text-slate-500 text-sm mb-6">Token manquant ou expiré. Si vous êtes admin, configurez-le.</p>
                                <input type="password" placeholder="Token Dropbox..." className="w-full p-3 border rounded-xl mb-4 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500" value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})} />
                                <button onClick={() => { if(dbxConfig.token) { setShowConfigModal(false); loadCloudDatabase(); } }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Valider</button>
                            </div>
                        </div>
                    )}

                    <div className="w-full max-w-md p-8 bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl border border-white/50 animate-fade relative">
                        {/* Indicateur de chargement discret */}
                        {syncStatus === 'working' && (
                            <div className="absolute top-4 right-4 flex items-center gap-2 text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-full animate-pulse">
                                <Icon name="Loader2" size={14} className="animate-spin"/> Sync...
                            </div>
                        )}

                        <div className="text-center mb-8">
                            <div className="inline-flex p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-200 mb-4"><Icon name="Database" size={32} className="text-white"/></div>
                            <h1 className="text-3xl font-black text-slate-800 mb-1">Tarifiers<span className="text-blue-600">DBX</span></h1>
                            <p className="text-slate-500 font-medium text-sm">Portail Unifié CMGP-CAS</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            {syncStatus === 'error' && (
                                <div className="bg-red-50 text-red-500 p-3 rounded-xl text-xs text-center font-bold border border-red-100 flex flex-col items-center gap-1">
                                    <span>⚠️ {syncLog}</span>
                                    <button type="button" onClick={() => setShowConfigModal(true)} className="underline text-red-700 hover:text-red-900 mt-1">Configurer le token</button>
                                </div>
                            )}
                            {loginError && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-sm text-center font-bold border border-red-100">{loginError}</div>}
                            <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} placeholder="Identifiant" />
                            <input type="password" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} placeholder="Mot de passe" />
                            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-2">
                                Se Connecter
                            </button>
                        </form>
                        
                        {/* Bouton de secours pour forcer la mise à jour des accès */}
                        <div className="mt-6 pt-4 border-t border-slate-200 text-center">
                            <button type="button" onClick={() => loadCloudDatabase(false)} className="text-xs font-bold text-slate-400 hover:text-blue-600 flex items-center justify-center gap-2 w-full transition-colors">
                                <Icon name="RefreshCw" size={12}/> Mettre à jour les accès (Cloud)
                            </button>
                        </div>

                        {!HARDCODED_DBX_TOKEN && <p className="text-xs text-center text-red-400 mt-4">⚠️ Token Dropbox manquant dans le code.</p>}
                    </div>
                </div>
            );

            return (
                <ErrorBoundary>
                    <div className="min-h-screen flex flex-col bg-slate-50 text-slate-900 font-sans relative">
                        
                        {/* LOADER GLOBAL POUR FICHIER */}
                        {isFileLoading && (
                            <div className="fixed inset-0 z-[110] bg-white/50 backdrop-blur-sm flex items-center justify-center animate-fade">
                                <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center border border-slate-100">
                                    <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <div className="font-bold text-slate-800">Chargement du document...</div>
                                    <div className="text-xs text-slate-400 mt-2">Récupération sécurisée RAM</div>
                                </div>
                            </div>
                        )}

                        {/* VIEWER MODAL (MOTEUR RENDU INTEGRE) */}
                        {viewingFile && (
                            <div className="fixed inset-0 z-[100] bg-slate-900 flex flex-col animate-fade">
                                <div className="flex items-center justify-between p-4 bg-slate-900 text-white border-b border-slate-700 shadow-xl z-20">
                                    <h3 className="font-bold truncate max-w-md flex items-center gap-2 text-sm md:text-base"><Icon name="FileText" size={18} className="text-blue-400"/> {viewingFile.name}</h3>
                                    <div className="flex gap-2 items-center">
                                        {viewingFile.type === 'pdf' && pdfState.numPages > 1 && (
                                            <div className="hidden md:flex bg-slate-800 rounded-lg p-1 mr-2 items-center">
                                                <button onClick={() => changePage(-1)} className="p-1 hover:text-blue-400"><Icon name="ChevronLeft"/></button>
                                                <span className="px-2 text-xs font-mono">{pdfState.pageNum} / {pdfState.numPages}</span>
                                                <button onClick={() => changePage(1)} className="p-1 hover:text-blue-400"><Icon name="ChevronRight"/></button>
                                            </div>
                                        )}
                                        {viewingFile.type === 'pdf' && (
                                            <div className="hidden md:flex bg-slate-800 rounded-lg p-1 mr-2">
                                                <button onClick={() => zoomPdf(-0.2)} className="p-1 hover:text-blue-400"><Icon name="Minus" size={16}/></button>
                                                <button onClick={() => zoomPdf(0.2)} className="p-1 hover:text-blue-400"><Icon name="Plus" size={16}/></button>
                                            </div>
                                        )}
                                        <a href={viewingFile.url} download={viewingFile.name} className="p-2 bg-slate-800 hover:bg-blue-600 rounded-lg text-slate-300 hover:text-white transition-colors" title="Sauvegarder (Optionnel)">
                                            <Icon name="Download" size={18}/>
                                        </a>
                                        <button onClick={closeViewer} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors" title="Fermer & Purger Mémoire">
                                            <Icon name="X" size={18}/>
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 relative bg-gray-800 overflow-auto flex justify-center p-4">
                                    {viewingFile.type === 'pdf' ? (
                                        <div className="relative shadow-2xl">
                                            <canvas ref={canvasRef} className="max-w-full h-auto bg-white"/>
                                            {/* Contrôles flottants mobile */}
                                            {pdfState.numPages > 1 && (
                                                <div className="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-4 py-2 rounded-full flex gap-4 items-center shadow-xl backdrop-blur-sm border border-slate-700">
                                                     <button onClick={() => changePage(-1)}><Icon name="ChevronLeft"/></button>
                                                     <span className="text-xs font-bold">{pdfState.pageNum}/{pdfState.numPages}</span>
                                                     <button onClick={() => changePage(1)}><Icon name="ChevronRight"/></button>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <img src={viewingFile.url} alt="Visuel" className="max-w-full max-h-full object-contain" />
                                    )}
                                </div>
                            </div>
                        )}

                        {/* CITATION MODAL */}
                        {showQuoteModal && currentQuote && (
                            <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[100] flex items-center justify-center p-6 animate-fade">
                                <div className="max-w-2xl w-full text-center text-white">
                                    <div className="mb-8"><Icon name="Quote" size={64} className="mx-auto text-blue-400 opacity-50"/></div>
                                    <h2 className="text-3xl md:text-5xl font-black mb-8 leading-tight">"{currentQuote.text}"</h2>
                                    <p className="text-xl text-blue-200 font-medium mb-12">— {currentQuote.author}</p>
                                    <button onClick={() => setShowQuoteModal(false)} className="bg-white text-slate-900 px-8 py-4 rounded-full font-bold text-lg hover:bg-blue-50 transition-transform hover:scale-105 shadow-xl">Accéder au Portail <Icon name="ArrowRight" className="inline ml-2"/></button>
                                </div>
                            </div>
                        )}

                        <nav className="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-8 sticky top-0 z-40">
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('search')}>
                                    <div className="bg-blue-600 text-white p-1.5 rounded-lg"><Icon name="Database" size={20} /></div>
                                    <span className="font-bold text-lg tracking-tight hidden md:inline">Tarifiers<span className="text-blue-600">DBX</span></span>
                                </div>
                                {/* MANUAL REFRESH BUTTON */}
                                <button onClick={() => loadCloudDatabase()} className="p-2 bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 rounded-full transition-colors" title="Forcer la mise à jour">
                                    <Icon name="RefreshCw" size={16} className={syncStatus === 'working' ? 'animate-spin' : ''}/>
                                </button>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {currentUser.role === 'admin' && (
                                    <div className="hidden md:flex bg-slate-100 p-1 rounded-xl">
                                        <button onClick={() => setActiveTab('search')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'search' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Recherche</button>
                                        <button onClick={() => setActiveTab('admin')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'admin' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Admin</button>
                                        <button onClick={() => setActiveTab('users')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'users' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Users</button>
                                    </div>
                                )}
                                <div className="h-8 w-px bg-slate-200 mx-1"></div>
                                <button onClick={handleLogout} className="flex items-center gap-2 text-slate-500 hover:text-red-600 transition-colors text-sm font-medium"><span className="hidden md:inline">{currentUser.name}</span><Icon name="LogOut" size={18} /></button>
                            </div>
                        </nav>

                        <main className="flex-1 max-w-6xl w-full mx-auto p-4 md:p-8">
                            {activeTab === 'search' && (
                                <div className="animate-fade">
                                    {/* BANNER INFO MAJ */}
                                    {dbMeta && (
                                        <div className="bg-blue-50 border border-blue-100 rounded-lg px-4 py-2 mb-6 flex justify-between items-center text-xs text-blue-800 animate-fade">
                                            <div className="flex gap-4">
                                                <span className="font-bold flex items-center gap-1"><Icon name="Clock" size={12}/> MAJ: {dbMeta.date}</span>
                                                <span className="hidden md:inline">|</span>
                                                <span className="flex items-center gap-1"><Icon name="User" size={12}/> {dbMeta.user}</span>
                                            </div>
                                            <div className="italic opacity-75 hidden md:block">Données synchronisées automatiquement</div>
                                        </div>
                                    )}

                                    {/* BANDEAU DEFILANT HISTORIQUE */}
                                    {dbHistory.length > 0 && (
                                        <div className="bg-slate-900 text-white py-2 px-4 rounded-lg mb-6 shadow-md border border-slate-700 overflow-hidden relative">
                                            <div className="absolute left-0 top-0 bottom-0 bg-gradient-to-r from-slate-900 to-transparent w-10 z-10"></div>
                                            <div className="absolute right-0 top-0 bottom-0 bg-gradient-to-l from-slate-900 to-transparent w-10 z-10"></div>
                                            <div className="marquee-container">
                                                <div className="marquee-content flex gap-8">
                                                    {dbHistory.map((h, i) => (
                                                        <span key={i} className="inline-flex items-center gap-2 text-xs font-mono">
                                                            <span className="text-blue-400">[{h.date}]</span>
                                                            <span className="font-bold text-yellow-400">{h.user}</span>:
                                                            <span>{h.action}</span>
                                                            <span className="text-slate-600 mx-2">|</span>
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* GRAPHIQUE STATISTIQUES */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                        <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                            <h3 className="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"><Icon name="BarChart2" size={14}/> Top Recherches (Local)</h3>
                                            <div className="space-y-3">
                                                {users.sort((a,b) => b.searchCount - a.searchCount).slice(0, 3).map((u, i) => (
                                                    <div key={i} className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs text-slate-600">{u.name.charAt(0)}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between text-xs mb-1">
                                                                <span className="font-bold text-slate-700">{u.name}</span>
                                                                <span className="text-slate-400">{u.searchCount} rech.</span>
                                                            </div>
                                                            <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                                <div className="h-full bg-blue-500 rounded-full bar-fill" style={{width: `${Math.min((u.searchCount / (Math.max(...users.map(u=>u.searchCount)) || 1)) * 100, 100)}%`}}></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                            <h3 className="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"><Icon name="PieChart" size={14}/> Base de Données</h3>
                                            <div className="flex gap-4 items-center h-full pb-4">
                                                <div className="flex-1 text-center p-4 bg-green-50 rounded-xl">
                                                    <div className="text-2xl font-black text-green-600">{tarifs.length}</div>
                                                    <div className="text-xs font-bold text-green-800 uppercase">Tarifs</div>
                                                </div>
                                                <div className="flex-1 text-center p-4 bg-indigo-50 rounded-xl">
                                                    <div className="text-2xl font-black text-indigo-600">{fiches.length}</div>
                                                    <div className="text-xs font-bold text-indigo-800 uppercase">Fiches</div>
                                                </div>
                                                <div className="flex-1 text-center p-4 bg-blue-50 rounded-xl">
                                                    <div className="text-2xl font-black text-blue-600">{tarifs.reduce((acc,t)=>acc+(t.products?.length||0),0)}</div>
                                                    <div className="text-xs font-bold text-blue-800 uppercase">Produits</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="max-w-3xl mx-auto text-center mb-10">
                                        <div className="relative group z-10">
                                            <input className="w-full p-5 pl-14 rounded-2xl border border-slate-200 shadow-xl shadow-slate-100 focus:ring-4 focus:ring-blue-50 outline-none text-lg font-medium transition-all" placeholder="Rechercher un produit ou une fiche..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} autoFocus />
                                            <div className="absolute left-5 top-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"><Icon name="Search" size={24} /></div>
                                        </div>
                                        <div className="mt-4 flex justify-center">
                                            <button onClick={() => uploadInputRef.current.click()} disabled={isUploading} className="text-xs font-bold text-slate-400 hover:text-blue-600 flex items-center gap-2 transition-colors bg-slate-50 hover:bg-blue-50 px-3 py-1.5 rounded-full">
                                                <Icon name={isUploading ? "Loader2" : "UploadCloud"} size={14} className={isUploading ? "animate-spin" : ""}/>{isUploading ? "Envoi..." : "Ajouter Fiche PDF"}
                                            </button>
                                            <input type="file" ref={uploadInputRef} onChange={handleUploadFiche} accept="application/pdf" className="hidden" />
                                        </div>
                                    </div>

                                    {/* RESULTATS */}
                                    <div className="space-y-8 pb-20">
                                        {searchResults.products.length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2"><Icon name="Box" size={16}/> Tarifs ({searchResults.products.length})</h3>
                                                <div className="space-y-3">
                                                    {searchResults.products.map((res, i) => {
                                                        // LOGIQUE TVA CORRIGÉE (Asterisk avant OU après)
                                                        const isTaxable = res.name && (res.name.trim().startsWith('*') || res.name.trim().endsWith('*'));
                                                        const priceVal = parseFloat(String(res.price).replace(/[^0-9.]/g, ''));
                                                        const validPrice = !isNaN(priceVal);
                                                        const priceHT = validPrice ? priceVal.toFixed(2) : res.price;
                                                        const priceTTC = validPrice ? (priceVal * 1.20).toFixed(2) : null;

                                                        return (
                                                            <div key={i} className="bg-white p-5 rounded-2xl border border-slate-100 hover:border-blue-300 hover:shadow-lg transition-all flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                                                <div className="flex items-start gap-4">
                                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center shrink-0 bg-blue-50 text-blue-600"><Icon name="Tag" size={20}/></div>
                                                                    <div>
                                                                        <div className="font-bold text-slate-800 text-lg">{res.name}</div>
                                                                        <div className="flex flex-wrap items-center gap-2 mt-2">
                                                                            <span className="bg-slate-100 px-2.5 py-1 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1"><Icon name="Folder" size={12}/> {res.source}</span>
                                                                            <span className="px-2.5 py-1 rounded-lg text-xs font-bold flex items-center gap-1 bg-green-50 text-green-600 border border-green-100"><Icon name="Calendar" size={12}/> {res.date_tarif}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center justify-between md:justify-end gap-3 pl-14 md:pl-0">
                                                                    <div className="text-right mr-4">
                                                                        {validPrice && isTaxable ? (
                                                                            <div className="flex flex-col items-end">
                                                                                <div className="text-sm font-bold text-slate-400">{priceHT} <span className="text-[10px]">HT</span></div>
                                                                                <div className="text-2xl font-black text-blue-600 whitespace-nowrap">{priceTTC} <span className="text-xs text-slate-400 font-bold">TTC</span></div>
                                                                            </div>
                                                                        ) : (
                                                                            <div className="text-2xl font-black text-green-600 whitespace-nowrap">
                                                                                {priceHT} <span className="text-xs text-green-800 font-bold">{validPrice ? 'EXO' : (res.unit || 'DH')}</span>
                                                                            </div>
                                                                        )}
                                                                        {validPrice && <div className="text-xs text-slate-400 font-bold mt-1 text-right">{res.unit || 'DH'}</div>}
                                                                    </div>
                                                                    <button onClick={() => openFile(res.path, res.source)} className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><Icon name="Eye" size={14}/> Voir</button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        {searchResults.fiches.length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2 border-t pt-6 mt-6 md:border-none md:pt-0 md:mt-0"><Icon name="FileText" size={16}/> Fiches ({searchResults.fiches.length})</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {searchResults.fiches.map((f, i) => (
                                                        <div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all flex items-center justify-between group">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center shrink-0"><Icon name="FileText" size={20}/></div>
                                                                <div className="truncate pr-4"><div className="font-bold text-slate-700 truncate">{f.name}</div><div className="text-xs text-slate-400">PDF</div></div>
                                                            </div>
                                                            <button onClick={() => openFile(f.path, f.name)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 rounded-lg transition-colors"><Icon name="Eye" size={18}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'admin' && currentUser.role === 'admin' && (
                                <div className="animate-fade grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1 space-y-6">
                                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><Icon name="Settings" /> Paramètres</h3>
                                            <div className="space-y-4">
                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Token Dropbox</label><input type="password" value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" /></div>
                                                
                                                {/* REFRESH TOKEN OAUTH SECTION */}
                                                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                                    <label className="text-[10px] font-bold uppercase text-blue-700 block mb-2">Connexion Permanente (OAuth)</label>
                                                    <div className="grid gap-1 mb-2"><input value={dbxConfig.appKey} onChange={e => setDbxConfig({...dbxConfig, appKey: e.target.value})} className="p-2 bg-white border border-blue-200 rounded text-xs" placeholder="App Key"/></div>
                                                    <div className="grid gap-1 mb-2"><input type="password" value={dbxConfig.appSecret} onChange={e => setDbxConfig({...dbxConfig, appSecret: e.target.value})} className="p-2 bg-white border border-blue-200 rounded text-xs" placeholder="App Secret"/></div>
                                                    
                                                    {dbxConfig.appKey && (
                                                        <a href={`https://www.dropbox.com/oauth2/authorize?client_id=${dbxConfig.appKey}&token_access_type=offline&response_type=code`} target="_blank" className="block w-full text-center bg-blue-600 text-white py-2 rounded-lg text-xs font-bold mb-2 hover:bg-blue-700">1. Autoriser l'App</a>
                                                    )}
                                                    
                                                    <div className="flex gap-2">
                                                        <input value={authCode} onChange={e => setAuthCode(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs" placeholder="2. Coller le Code"/>
                                                        <button onClick={handleExchangeCode} disabled={syncStatus === 'working'} className="bg-green-600 text-white px-3 rounded-lg hover:bg-green-700 font-bold text-xs">Valider</button>
                                                    </div>
                                                    {dbxConfig.refreshToken && (
                                                        <div className="mt-3 bg-white p-2 rounded border border-green-200">
                                                            <div className="text-[10px] text-green-600 font-bold mb-1">✅ Token Permanent Actif</div>
                                                            <label className="text-[9px] font-bold uppercase text-slate-400 block mb-1">REFRESH TOKEN (A COPIER DANS LE CODE)</label>
                                                            <div className="flex items-center gap-2">
                                                                <input readOnly value={dbxConfig.refreshToken} className="flex-1 p-1 bg-slate-50 border border-slate-200 rounded text-[10px] font-mono text-slate-500 select-all" onClick={e => e.target.select()}/>
                                                                <button onClick={() => { navigator.clipboard.writeText(dbxConfig.refreshToken); alert("Copié !"); }} className="p-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-500" title="Copier"><Icon name="Copy" size={12}/></button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Clé Gemini</label><input type="password" value={dbxConfig.geminiKey} onChange={e => setDbxConfig({...dbxConfig, geminiKey: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" /></div>
                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Dossier Tarifs</label><input value={dbxConfig.pathTarifs} onChange={e => setDbxConfig({...dbxConfig, pathTarifs: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs" /></div>
                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Dossier Fiches</label><input value={dbxConfig.pathFT} onChange={e => setDbxConfig({...dbxConfig, pathFT: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs" /></div>
                                                
                                                {/* BOUTONS SAUVEGARDE */}
                                                <div className="pt-4 mt-4 border-t border-slate-100 flex flex-col gap-2">
                                                    <button onClick={handleManualCloudSave} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-xs flex items-center justify-center gap-2 transition-colors shadow-sm">
                                                        <Icon name="CloudUpload" size={14}/> Publier la Base sur le Cloud (MàJ)
                                                    </button>
                                                    <button onClick={handleLocalExport} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-2 rounded-xl text-xs flex items-center justify-center gap-2 transition-colors">
                                                        <Icon name="HardDriveDownload" size={14}/> Télécharger Backup Local (Secours)
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900 text-green-400 p-5 rounded-3xl font-mono text-xs h-60 overflow-y-auto shadow-inner"><div className="opacity-50 border-b border-green-800 pb-2 mb-2">System Logs</div><div className="whitespace-pre-wrap">{syncLog || "Prêt."}</div></div>
                                    </div>
                                    
                                    {/* Modal Upload Admin */}
                                    {showAdminUploadModal && (
                                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
                                            <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full animate-fade relative">
                                                <button onClick={() => setShowAdminUploadModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="X"/></button>
                                                <div className="mb-6"><div className="inline-flex bg-blue-100 p-3 rounded-full text-blue-600 mb-3"><Icon name="FilePlus" size={24}/></div><h2 className="text-xl font-bold">Gestion Tarifs</h2><p className="text-sm text-slate-500">Ajouter ou remplacer un catalogue</p></div>
                                                <form onSubmit={handleManualTarifUpload} className="space-y-4">
                                                    <div className="flex bg-slate-50 p-1 rounded-xl">
                                                        <button type="button" onClick={() => setAdminUploadMode('new')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${adminUploadMode === 'new' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Nouveau</button>
                                                        <button type="button" onClick={() => setAdminUploadMode('update')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${adminUploadMode === 'update' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Mise à jour</button>
                                                    </div>
                                                    {adminUploadMode === 'update' && (
                                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Tarif à remplacer</label><select className="w-full p-3 border rounded-xl text-sm bg-white" required value={targetTarifId} onChange={e => setTargetTarifId(e.target.value)}><option value="">-- Choisir --</option>{tarifs.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                                    )}
                                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Fichier PDF</label><input type="file" accept="application/pdf" required ref={adminFileInputRef} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/></div>
                                                    <button disabled={syncStatus === 'working'} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-2 hover:bg-slate-900 disabled:opacity-50 flex items-center justify-center gap-2">{syncStatus === 'working' ? <Icon name="Loader2" className="animate-spin"/> : <Icon name="UploadCloud"/>} Valider</button>
                                                </form>
                                            </div>
                                        </div>
                                    )}

                                    <div className="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                            <h3 className="font-bold text-lg text-slate-800">Indexation</h3>
                                            <div className="flex gap-2">
                                                <button onClick={handleDeleteAllTarifs} className="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-2 rounded-xl font-bold text-xs flex items-center gap-1 transition-colors"><Icon name="Trash2" size={14}/> Tout Supprimer</button>
                                                <button onClick={() => { setAdminUploadMode('new'); setShowAdminUploadModal(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-indigo-200 transition-all active:scale-95"><Icon name="Plus"/> Gestion Tarifs</button>
                                                <button onClick={() => runFullSync(false)} disabled={syncStatus === 'working'} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-blue-200 transition-all active:scale-95 disabled:opacity-50"><Icon name={syncStatus === 'working' ? "Loader2" : "RefreshCw"} className={syncStatus === 'working' ? "animate-spin" : ""}/> Re-Scan Global</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-auto p-0">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-white sticky top-0 shadow-sm text-slate-500 font-bold text-[10px] uppercase">
                                                    <tr><th className="p-4">Fichier</th><th className="p-4">Type</th><th className="p-4 text-center">Info</th><th className="p-4 text-right">Actions</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {tarifs.map(t => (
                                                        <tr key={t.id} className="hover:bg-blue-50/30 group">
                                                            <td className="p-4 font-bold text-slate-700">{t.name}</td>
                                                            <td className="p-4"><span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">TARIF</span></td>
                                                            <td className="p-4 text-center text-blue-600 font-bold">{t.products?.length} produits</td>
                                                            <td className="p-4 text-right">
                                                                <button onClick={() => handleDeleteEntry('tarif', t.id, t.name)} className="text-slate-300 hover:text-red-500 transition-colors p-2" title="Supprimer"><Icon name="Trash2" size={16}/></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {fiches.map(f => (
                                                        <tr key={f.id} className="hover:bg-indigo-50/30 group">
                                                            <td className="p-4 font-bold text-slate-700">{f.name}</td>
                                                            <td className="p-4"><span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">FICHE</span></td>
                                                            <td className="p-4 text-center text-slate-400">PDF</td>
                                                            <td className="p-4 text-right">
                                                                <button onClick={() => handleDeleteEntry('fiche', f.id, f.name)} className="text-slate-300 hover:text-red-500 transition-colors p-2" title="Supprimer"><Icon name="Trash2" size={16}/></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'users' && currentUser.role === 'admin' && (
                                <div className="max-w-xl mx-auto space-y-8 animate-fade">
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name={editingUserIdx !== null ? "Edit" : "UserPlus"}/> {editingUserIdx !== null ? "Modifier" : "Créer un accès"}</h3>
                                        <form onSubmit={handleUserSubmit} className="grid gap-4">
                                            <div className="grid grid-cols-2 gap-4"><input value={userFormData.name} onChange={e => setUserFormData({...userFormData, name: e.target.value})} name="name" placeholder="Nom Complet" required className="p-3 border rounded-xl text-sm" /><select value={userFormData.role} onChange={e => setUserFormData({...userFormData, role: e.target.value})} name="role" className="p-3 border rounded-xl text-sm bg-white"><option value="viewer">Collaborateur</option><option value="admin">Administrateur</option></select></div>
                                            <div className="grid grid-cols-2 gap-4"><input value={userFormData.login} onChange={e => setUserFormData({...userFormData, login: e.target.value})} name="login" placeholder="Identifiant" required className="p-3 border rounded-xl text-sm" /><input value={userFormData.pass} onChange={e => setUserFormData({...userFormData, pass: e.target.value})} name="pass" placeholder="Mot de passe" required className="p-3 border rounded-xl text-sm" /></div>
                                            <div className="flex gap-2 mt-2"><button className="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">{editingUserIdx !== null ? "Enregistrer" : "Ajouter"}</button>{editingUserIdx !== null && (<button type="button" onClick={() => { setEditingUserIdx(null); setUserFormData({ name: '', login: '', pass: '', role: 'viewer' }); }} className="bg-slate-100 text-slate-500 py-3 px-4 rounded-xl font-bold hover:bg-slate-200">Annuler</button>)}</div>
                                        </form>
                                    </div>
                                    <div className="space-y-3">
                                        <h4 className="text-xs font-bold uppercase text-slate-400 pl-4">Utilisateurs</h4>
                                        {users.map((u, i) => (
                                            <div key={i} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl group">
                                                <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${u.role === 'admin' ? 'bg-slate-800' : 'bg-blue-500'}`}>{u.name.charAt(0)}</div><div><div className="font-bold text-slate-800">{u.name}</div><div className="text-xs text-slate-500 font-mono flex items-center gap-2"><span>{u.id}</span><span className="text-slate-300">|</span><button onClick={() => setShowPassword({...showPassword, [i]: !showPassword[i]})} className="flex items-center gap-1 hover:text-blue-600 transition-colors">{showPassword[i] ? u.pass : "••••••"}<Icon name={showPassword[i] ? "EyeOff" : "Eye"} size={10}/></button></div></div></div>
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setUserFormData({ name: u.name, login: u.id, pass: u.pass, role: u.role }); setEditingUserIdx(i); }} className="p-2 text-blue-400 hover:text-blue-600 bg-blue-50 rounded-lg"><Icon name="Edit2" size={16}/></button><button onClick={() => { if(confirm('Supprimer ?')) setUsers(users.filter((_, idx) => idx !== i)); }} className="p-2 text-red-400 hover:text-red-600 bg-red-50 rounded-lg"><Icon name="Trash2" size={16}/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </ErrorBoundary>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>