<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Tarifs CMGP-CAS (Dropbox Sync)</title>
    <!-- Bibliothèques React & UI -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Moteurs PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Configuration PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- SERVICES DROPBOX ---
        const DROPBOX_API_URL = "https://api.dropboxapi.com/2";
        const DROPBOX_CONTENT_URL = "https://content.dropboxapi.com/2";

        const dbxListFolder = async (token, path) => {
            const res = await fetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path === '/' ? '' : path, recursive: false, include_media_info: false })
            });
            if (!res.ok) throw new Error(await res.text());
            return await res.json();
        };

        const dbxDownloadFile = async (token, path) => {
            const res = await fetch(`${DROPBOX_CONTENT_URL}/files/download`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Dropbox-API-Arg': JSON.stringify({ path }) }
            });
            if (!res.ok) throw new Error(await res.text());
            return await res.blob();
        };

        // Fonction d'attente pour éviter de saturer l'IA
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- IA GOOGLE ---
        const apiKeyIA = "AIzaSyC6-bG7HPhBnjmctpJPPYI29OSiM_S4JFg"; 
        
        const callIA = async (payload) => {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKeyIA}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return await res.json();
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, class: className } });
                    iconRef.current.innerHTML = `<i data-lucide="${name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase()}"></i>`;
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        function App() {
            // --- ETATS ---
            const [view, setView] = useState('login'); 
            const [adminTab, setAdminTab] = useState('sync'); 
            const [searchTab, setSearchTab] = useState('tarifs'); 
            
            const [tarifs, setTarifs] = useState([]);
            const [fichesTechniques, setFichesTechniques] = useState([]);
            const [syncInfo, setSyncInfo] = useState({ lastSync: null, recentFiles: [] });
            
            const [dbxConfig, setDbxConfig] = useState({ 
                token: '', 
                pathTarifs: '/Tarifs', 
                pathFT: '/Fiches' 
            });

            const [queryStr, setQueryStr] = useState('');
            const [ftQueryStr, setFtQueryStr] = useState('');
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [syncStatus, setSyncStatus] = useState(null); 
            const [syncLog, setSyncLog] = useState('');
            const fileInputRef = useRef(null); // Pour l'import de config

            // --- CHARGEMENT PERSISTANCE ---
            useEffect(() => {
                const savedTarifs = localStorage.getItem('cmgp_dbx_tarifs');
                const savedFT = localStorage.getItem('cmgp_dbx_ft');
                const savedConfig = localStorage.getItem('cmgp_dbx_config');
                const savedSync = localStorage.getItem('cmgp_dbx_sync_info');

                if (savedTarifs) setTarifs(JSON.parse(savedTarifs));
                if (savedFT) setFichesTechniques(JSON.parse(savedFT));
                if (savedConfig) setDbxConfig(JSON.parse(savedConfig));
                if (savedSync) setSyncInfo(JSON.parse(savedSync));
            }, []);

            useEffect(() => { localStorage.setItem('cmgp_dbx_tarifs', JSON.stringify(tarifs)); }, [tarifs]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_ft', JSON.stringify(fichesTechniques)); }, [fichesTechniques]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_config', JSON.stringify(dbxConfig)); }, [dbxConfig]);
            useEffect(() => { localStorage.setItem('cmgp_dbx_sync_info', JSON.stringify(syncInfo)); }, [syncInfo]);

            // --- FONCTIONS SAUVEGARDE / RESTAURATION ---
            const handleExportConfig = () => {
                const data = {
                    tarifs,
                    fichesTechniques,
                    dbxConfig,
                    syncInfo,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cmgp_config_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const handleImportConfig = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.tarifs) setTarifs(data.tarifs);
                        if (data.fichesTechniques) setFichesTechniques(data.fichesTechniques);
                        if (data.dbxConfig) setDbxConfig(data.dbxConfig);
                        if (data.syncInfo) setSyncInfo(data.syncInfo);
                        alert("Configuration et données restaurées avec succès !");
                    } catch (error) {
                        alert("Erreur lors de la lecture du fichier de sauvegarde.");
                    }
                };
                reader.readAsText(file);
            };

            // --- LOGIQUE METIER IA & PARSING ---
            const analyzeTarifPDF = async (blob) => {
                try {
                    const arrayBuffer = await blob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let allProducts = [];
                    // Limite à 2 pages pour la vitesse
                    for (let i = 1; i <= Math.min(pdf.numPages, 2); i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        
                        // Appel IA
                        const result = await callIA({
                            contents: [{ parts: [{ text: "Extrais produits, prix HT, format. JSON uniquement: { 'products': [ { 'name': '...', 'price': '...', 'packaging': '...' } ] }" }, { inlineData: { mimeType: "image/png", data: canvas.toDataURL('image/png').split(',')[1] } } ] }],
                            generationConfig: { responseMimeType: "application/json" }
                        });
                        
                        if (result.candidates && result.candidates[0].content) {
                            let text = result.candidates[0].content.parts[0].text;
                            // NETTOYAGE : Suppression des balises Markdown ```json et ```
                            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                            
                            try {
                                const data = JSON.parse(text);
                                if (data.products && Array.isArray(data.products)) {
                                    allProducts.push(...data.products);
                                }
                            } catch(jsonErr) {
                                console.warn("Erreur structure JSON brute:", text);
                            }
                        }
                    }
                    return allProducts;
                } catch (e) {
                    console.error("Erreur lecture PDF ou IA", e);
                    return []; 
                }
            };

            const analyzeFTName = async (blob, filename) => {
                let name = filename.replace(/\.pdf$/i, '').replace(/_/g, ' ');
                return name;
            };

            // --- MOTEUR DE SYNC DROPBOX ---
            const runSync = async () => {
                if (!dbxConfig.token) return alert("Veuillez configurer le Token Dropbox dans l'onglet Config.");
                
                setSyncStatus('loading');
                setSyncLog('Démarrage synchronisation...');
                const newRecentFiles = [];
                let updatesCount = 0;

                try {
                    // 1. SYNC TARIFS (Avec protection boucle)
                    setSyncLog(`>>> Analyse Tarifs (${dbxConfig.pathTarifs})`);
                    try {
                        const listTarifs = await dbxListFolder(dbxConfig.token, dbxConfig.pathTarifs);
                        const currentTarifIds = tarifs.map(t => t.id);
                        const validEntryIds = [];

                        for (const entry of listTarifs.entries) {
                            if (entry['.tag'] !== 'file' || !entry.name.toLowerCase().endsWith('.pdf')) continue;
                            
                            validEntryIds.push(entry.id);
                            const existing = tarifs.find(t => t.id === entry.id);

                            // CONDITION DE MISE A JOUR : Nouveau ou Date modifiée
                            // NOTE: On peut forcer la réanalyse si existing.products.length === 0 pour corriger les erreurs passées
                            const needsUpdate = !existing || existing.server_modified !== entry.server_modified || (existing.products && existing.products.length === 0);

                            if (needsUpdate) {
                                setSyncLog(`Traitement : ${entry.name}...`);
                                
                                try {
                                    // Téléchargement
                                    const blob = await dbxDownloadFile(dbxConfig.token, entry.path_lower);
                                    
                                    // Pause anti-spam IA (1.5 secondes)
                                    await delay(1500); 

                                    // Analyse IA
                                    const products = await analyzeTarifPDF(blob);
                                    
                                    if (products.length === 0) {
                                        setSyncLog(`⚠️ 0 produits trouvés dans ${entry.name}. Vérifiez le format.`);
                                    } else {
                                        setSyncLog(`✅ ${products.length} produits extraits de ${entry.name}`);
                                    }

                                    const newDoc = {
                                        id: entry.id,
                                        name: entry.name,
                                        path: entry.path_lower,
                                        server_modified: entry.server_modified,
                                        products: products,
                                        type: 'tarif'
                                    };
                                    
                                    setTarifs(prev => [...prev.filter(p => p.id !== entry.id), newDoc]);
                                    newRecentFiles.push({ name: entry.name, type: 'tarif', date: new Date().toLocaleTimeString() });
                                    updatesCount++;

                                } catch (fileError) {
                                    setSyncLog(`❌ ÉCHEC fichier ${entry.name} : ${fileError.message}`);
                                }
                            }
                        }
                        // Nettoyage des orphelins (fichiers supprimés de Dropbox)
                        setTarifs(prev => prev.filter(t => validEntryIds.includes(t.id)));

                    } catch (e) {
                        console.error("Erreur Sync Tarifs", e);
                        setSyncLog("Erreur critique sur dossier Tarifs : " + e.message);
                    }

                    // 2. SYNC FICHES TECHNIQUES
                    setSyncLog(`>>> Analyse Fiches (${dbxConfig.pathFT})`);
                    try {
                        const listFT = await dbxListFolder(dbxConfig.token, dbxConfig.pathFT);
                        const validFTIds = [];

                        for (const entry of listFT.entries) {
                            if (entry['.tag'] !== 'file') continue;
                            
                            validFTIds.push(entry.id);
                            const existing = fichesTechniques.find(f => f.id === entry.id);

                            if (!existing || existing.server_modified !== entry.server_modified) {
                                setSyncLog(`Indexation : ${entry.name}`);
                                const productName = await analyzeFTName(null, entry.name);

                                const newDoc = {
                                    id: entry.id,
                                    fileName: entry.name,
                                    productName: productName,
                                    path: entry.path_lower,
                                    server_modified: entry.server_modified,
                                    type: 'ft'
                                };

                                setFichesTechniques(prev => [...prev.filter(f => f.id !== entry.id), newDoc]);
                                newRecentFiles.push({ name: entry.name, type: 'ft', date: new Date().toLocaleTimeString() });
                                updatesCount++;
                            }
                        }
                        setFichesTechniques(prev => prev.filter(f => validFTIds.includes(f.id)));

                    } catch (e) {
                        console.error("Erreur Sync FT", e);
                        setSyncLog("Erreur dossier FT (Vérifiez le chemin).");
                    }

                    setSyncInfo({
                        lastSync: new Date().toLocaleString(),
                        recentFiles: [...newRecentFiles, ...syncInfo.recentFiles].slice(0, 10)
                    });
                    setSyncStatus('success');
                    setSyncLog(`Terminé ! ${updatesCount} fichier(s) traité(s).`);

                } catch (globalError) {
                    console.error(globalError);
                    setSyncStatus('error');
                    setSyncLog("Erreur générale : " + globalError.message);
                }
            };

            const openDropboxFile = async (path) => {
                if (!dbxConfig.token) return alert("Token manquant");
                try {
                    const res = await fetch(`${DROPBOX_API_URL}/files/get_temporary_link`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${dbxConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: path })
                    });
                    const data = await res.json();
                    if (data.link) window.open(data.link, '_blank');
                    else alert("Impossible de générer le lien.");
                } catch (e) {
                    alert("Erreur ouverture fichier.");
                }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (loginForm.username.toLowerCase() === 'admin' && loginForm.password === 'admin') {
                    setView('search');
                } else {
                    setLoginError('Identifiants incorrects (admin/admin)');
                }
            };

            const searchResults = useMemo(() => {
                if (queryStr.length < 2) return [];
                const res = [];
                tarifs.forEach(t => {
                    (t.products || []).forEach(p => {
                        if (String(p.name).toLowerCase().includes(queryStr.toLowerCase())) {
                            res.push({ ...p, source: t.name, path: t.path, sourceId: t.id });
                        }
                    });
                });
                return res;
            }, [queryStr, tarifs]);

            const ftSearchResults = useMemo(() => {
                if (ftQueryStr.length < 2) return [];
                return fichesTechniques.filter(ft => 
                    (ft.productName || "").toLowerCase().includes(ftQueryStr.toLowerCase()) || 
                    (ft.fileName || "").toLowerCase().includes(ftQueryStr.toLowerCase())
                );
            }, [ftQueryStr, fichesTechniques]);

            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-slate-100">
                    <div className="max-w-sm w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 animate-fade">
                        <div className="bg-blue-600 p-8 text-center text-white">
                            <div className="flex justify-center mb-4"><div className="bg-white/20 p-3 rounded-xl"><Icon name="Box" size={32} className="text-white"/></div></div>
                            <h1 className="text-2xl font-black tracking-tight">CMGP-CAS</h1>
                            <p className="text-blue-100 text-xs font-medium mt-1">Connecteur Dropbox Intelligent</p>
                        </div>
                        <form onSubmit={handleLogin} className="p-8 space-y-4">
                            {loginError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs font-bold text-center">{loginError}</div>}
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">Utilisateur</label>
                                <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">Mot de passe</label>
                                <input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} />
                            </div>
                            <button className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-800 transition-transform active:scale-95">SE CONNECTER</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 font-sans text-slate-800">
                    <nav className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 sticky top-0 z-50">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('search')}>
                            <div className="bg-blue-600 p-1.5 rounded-lg"><Icon name="Box" className="text-white" size={18}/></div>
                            <span className="font-black text-lg tracking-tight text-slate-800">CMGP<span className="text-blue-600">DBX</span></span>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setView('search')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'search' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Recherche</button>
                            <button onClick={() => setView('admin')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${view === 'admin' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Admin & Sync</button>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-5xl w-full mx-auto p-6">
                        {view === 'search' && (
                            <div className="animate-fade">
                                <div className="flex justify-center gap-4 mb-8">
                                    <button onClick={() => setSearchTab('tarifs')} className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold text-sm transition-all ${searchTab === 'tarifs' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}><Icon name="DollarSign" size={16}/> Tarifs</button>
                                    <button onClick={() => setSearchTab('ft')} className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold text-sm transition-all ${searchTab === 'ft' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}><Icon name="FileText" size={16}/> Fiches Techniques</button>
                                </div>

                                {searchTab === 'tarifs' && (
                                    <div className="max-w-2xl mx-auto">
                                        <div className="relative mb-8 group"><div className="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-blue-500 transition-colors"><Icon name="Search" size={20}/></div><input className="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-blue-50 outline-none text-lg transition-all placeholder:text-slate-300" placeholder="Rechercher un prix (ex: Pompe X200)..." value={queryStr} onChange={e => setQueryStr(e.target.value)}/></div>
                                        <div className="space-y-3">{searchResults.map((p, i) => (<div key={i} className="bg-white p-4 rounded-xl border border-slate-100 hover:border-blue-300 hover:shadow-md transition-all group flex items-center justify-between cursor-default"><div className="flex items-center gap-4"><div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-bold text-lg">{p.name.charAt(0).toUpperCase()}</div><div><div className="font-bold text-slate-800">{p.name}</div><div className="text-xs text-slate-400 font-medium flex items-center gap-1"><Icon name="Box" size={10}/> {p.packaging} • <span className="text-blue-400">{p.source}</span></div></div></div><div className="text-right"><div className="text-xl font-black text-slate-800">{p.price} <span className="text-xs font-bold text-slate-400">DH</span></div><button onClick={() => openDropboxFile(p.path)} className="text-[10px] font-bold text-blue-600 hover:underline mt-1 flex items-center justify-end gap-1">Voir Source <Icon name="ExternalLink" size={10}/></button></div></div>))}{searchResults.length === 0 && queryStr.length > 1 && (<div className="text-center py-12 text-slate-400"><Icon name="Ghost" size={32} className="mx-auto mb-2 opacity-50"/><p>Aucun produit trouvé dans les tarifs synchronisés.</p></div>)}</div>
                                    </div>
                                )}

                                {searchTab === 'ft' && (
                                    <div className="max-w-2xl mx-auto">
                                        <div className="relative mb-8 group"><div className="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-300 group-focus-within:text-indigo-500 transition-colors"><Icon name="Search" size={20}/></div><input className="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-indigo-50 outline-none text-lg transition-all placeholder:text-slate-300" placeholder="Rechercher une fiche technique..." value={ftQueryStr} onChange={e => setFtQueryStr(e.target.value)}/></div>
                                        <div className="grid grid-cols-2 gap-4">{ftSearchResults.map((ft, i) => (<div key={i} onClick={() => openDropboxFile(ft.path)} className="bg-white p-4 rounded-xl border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer group"><div className="flex items-start justify-between mb-3"><div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><Icon name="FileText" size={20}/></div><span className="text-[10px] font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">PDF</span></div><h3 className="font-bold text-slate-700 group-hover:text-indigo-600 transition-colors line-clamp-2">{ft.productName}</h3><p className="text-xs text-slate-400 mt-1 truncate">{ft.fileName}</p></div>))}</div>
                                        {ftSearchResults.length === 0 && ftQueryStr.length > 1 && <p className="text-center py-12 text-slate-400">Aucune fiche trouvée sur Dropbox.</p>}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="animate-fade">
                                <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-4 mb-8">
                                        <div className="bg-blue-600 text-white p-3 rounded-xl"><Icon name="Cloud" size={24}/></div>
                                        <div><h2 className="text-xl font-bold text-slate-800">Centre de Synchronisation</h2><p className="text-sm text-slate-500">Gérez la connexion avec Dropbox</p></div>
                                    </div>

                                    <div className="flex gap-4 mb-6 border-b border-slate-100 pb-1">
                                        <button onClick={() => setAdminTab('sync')} className={`pb-3 px-2 text-sm font-bold border-b-2 transition-colors ${adminTab === 'sync' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>État & Sync</button>
                                        <button onClick={() => setAdminTab('config')} className={`pb-3 px-2 text-sm font-bold border-b-2 transition-colors ${adminTab === 'config' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>Configuration</button>
                                    </div>

                                    {adminTab === 'sync' && (
                                        <div className="space-y-6">
                                            <div className="bg-slate-50 rounded-2xl p-6 border border-slate-200 flex flex-col md:flex-row items-center justify-between gap-6">
                                                <div><div className="text-xs font-bold text-slate-400 uppercase mb-1">Dernière mise à jour</div><div className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="Clock" size={18} className="text-slate-400"/>{syncInfo.lastSync || "Jamais"}</div><div className="text-xs text-slate-500 mt-2">{tarifs.length} tarifs • {fichesTechniques.length} fiches indexées</div></div>
                                                <button onClick={runSync} disabled={syncStatus === 'loading'} className={`px-6 py-3 rounded-xl font-bold text-white shadow-lg flex items-center gap-2 transition-all ${syncStatus === 'loading' ? 'bg-slate-400 cursor-wait' : 'bg-blue-600 hover:bg-blue-700 active:scale-95'}`}><Icon name={syncStatus === 'loading' ? 'Loader2' : 'RefreshCw'} className={syncStatus === 'loading' ? 'animate-spin' : ''}/>{syncStatus === 'loading' ? 'Scan en cours...' : 'Synchroniser Maintenant'}</button>
                                            </div>
                                            <div className="bg-slate-900 rounded-xl p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto">
                                                <div className="opacity-50 mb-2"># Console de synchronisation Dropbox...</div>
                                                {syncLog && <div className="whitespace-pre-line">> {syncLog}</div>}
                                            </div>
                                        </div>
                                    )}

                                    {adminTab === 'config' && (
                                        <div className="space-y-6 max-w-lg">
                                            <div className="bg-yellow-50 text-yellow-800 p-4 rounded-xl text-xs border border-yellow-100 leading-relaxed">
                                                <strong className="block mb-1">Comment obtenir le Token ?</strong>
                                                1. Allez sur <a href="https://www.dropbox.com/developers/apps" target="_blank" className="underline font-bold">Dropbox Developers</a>.<br/>
                                                2. Créez une app ("Scoped access", "Full Dropbox").<br/>
                                                3. Dans l'onglet "Permissions", cochez <code>files.content.read</code>.<br/>
                                                4. Dans l'onglet "Settings", générez un "Generated Access Token".
                                            </div>
                                            
                                            {/* Zone Export / Import pour migration */}
                                            <div className="bg-blue-50 text-blue-900 p-4 rounded-xl text-xs border border-blue-100 flex justify-between items-center">
                                                <div>
                                                    <strong className="block">Sauvegarder / Restaurer</strong>
                                                    <span className="opacity-75">Pour migrer vers un autre hébergement (ou Local)</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={handleExportConfig} className="bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-lg hover:bg-blue-50 font-bold shadow-sm flex items-center gap-1"><Icon name="Download" size={14}/> Exporter</button>
                                                    <button onClick={() => fileInputRef.current.click()} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 font-bold shadow-sm flex items-center gap-1"><Icon name="Upload" size={14}/> Importer</button>
                                                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportConfig} />
                                                </div>
                                            </div>

                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Token d'Accès Dropbox</label><input type="password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm" placeholder="sl.BHz..." value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})}/></div>
                                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Dossier Tarifs</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="/Tarifs" value={dbxConfig.pathTarifs} onChange={e => setDbxConfig({...dbxConfig, pathTarifs: e.target.value})}/></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Dossier Fiches</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="/Fiches" value={dbxConfig.pathFT} onChange={e => setDbxConfig({...dbxConfig, pathFT: e.target.value})}/></div></div>
                                            <div className="pt-4"><button onClick={() => { alert('Configuration sauvegardée !'); setAdminTab('sync'); }} className="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-900">Sauvegarder</button></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>